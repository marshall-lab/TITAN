<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="http://marshall-lab.github.io/TITAN/api/utilities/" rel="canonical"/>
<link href="../../img/favicon.ico" rel="shortcut icon"/>
<title>Utility Functions - TITAN</title>
<link href="../../css/bootstrap.min.css" rel="stylesheet"/>
<link href="../../css/font-awesome.min.css" rel="stylesheet"/>
<link href="../../css/base.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" rel="stylesheet"/>
<script defer="" src="../../js/jquery-1.10.2.min.js"></script>
<script defer="" src="../../js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</head>
<body>
<div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
<div class="container">
<a class="navbar-brand" href="../..">TITAN</a>
<!-- Expander button -->
<button class="navbar-toggler" data-target="#navbar-collapse" data-toggle="collapse" type="button">
<span class="navbar-toggler-icon"></span>
</button>
<!-- Expanded navigation -->
<div class="navbar-collapse collapse" id="navbar-collapse">
<!-- Main navigation -->
<ul class="nav navbar-nav">
<li class="navitem">
<a class="nav-link" href="../..">Overview</a>
</li>
<li class="dropdown">
<a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Getting Started <b class="caret"></b></a>
<ul class="dropdown-menu">
<li>
<a class="dropdown-item" href="../../getting_started/">Installation</a>
</li>
<li>
<a class="dropdown-item" href="../../run_local/">Running locally</a>
</li>
<li>
<a class="dropdown-item" href="../../run_oscar/">Running on Oscar</a>
</li>
<li>
<a class="dropdown-item" href="../../contributing/">Contributing</a>
</li>
</ul>
</li>
<li class="dropdown active">
<a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">API Reference <b class="caret"></b></a>
<ul class="dropdown-menu">
<li>
<a class="dropdown-item" href="../agent/">Agent</a>
</li>
<li>
<a class="dropdown-item" href="../agent_set/">AgentSet</a>
</li>
<li>
<a class="dropdown-item" href="../location/">Location</a>
</li>
<li>
<a class="dropdown-item" href="../model/">Model</a>
</li>
<li>
<a class="dropdown-item" href="../network/">NetworkGraphUtils</a>
</li>
<li>
<a class="dropdown-item" href="../population/">Population</a>
</li>
<li>
<a class="dropdown-item" href="../relationship/">Relationship</a>
</li>
<li>
<a class="dropdown-item" href="../reporting/">Reporting</a>
</li>
<li>
<a class="dropdown-item active" href="./">Utility Functions</a>
</li>
</ul>
</li>
</ul>
<ul class="nav navbar-nav ml-auto">
<li class="nav-item">
<a class="nav-link" data-target="#mkdocs_search_modal" data-toggle="modal" href="#">
<i class="fa fa-search"></i> Search
                            </a>
</li>
<li class="nav-item">
<a class="nav-link" href="../reporting/" rel="prev">
<i class="fa fa-arrow-left"></i> Previous
                                </a>
</li>
<li class="nav-item">
<a class="nav-link disabled" rel="next">
                                    Next <i class="fa fa-arrow-right"></i>
</a>
</li>
</ul>
</div>
</div>
</div>
<div class="container">
<div class="row">
<div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
<div class="navbar-header">
<button class="navbar-toggler collapsed" data-target="#toc-collapse" data-toggle="collapse" title="Table of Contents" type="button">
<span class="fa fa-angle-down"></span>
</button>
</div>
<div class="navbar-collapse collapse card bg-secondary" id="toc-collapse">
<ul class="nav flex-column">
<li class="nav-item" data-level="2"><a class="nav-link" href="#general-utilities">General Utilities</a>
<ul class="nav flex-column">
</ul>
</li>
<li class="nav-item" data-level="2"><a class="nav-link" href="#probability-distributions">Probability Distributions</a>
<ul class="nav flex-column">
</ul>
</li>
<li class="nav-item" data-level="2"><a class="nav-link" href="#params">Params</a>
<ul class="nav flex-column">
</ul>
</li>
<li class="nav-item" data-level="2"><a class="nav-link" href="#partnering">Partnering</a>
<ul class="nav flex-column">
</ul>
</li>
<li class="nav-item" data-level="2"><a class="nav-link" href="#complex-probabilities">Complex Probabilities</a>
<ul class="nav flex-column">
</ul>
</li>
</ul>
</div>
</div></div>
<div class="col-md-9" role="main">
<h2 id="general-utilities">General Utilities</h2>
<div class="doc doc-object doc-module">
<div class="doc doc-contents first">
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="titan.utils.binom_0">
<code class="highlight language-python">
binom_0<span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>Mirrors scipy binom.pmf as used in code</p>
<details class="quote">
<summary>Source code in <code>titan/utils.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">binom_0</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Mirrors scipy binom.pmf as used in code</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span> <span class="o">**</span> <span class="n">n</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="titan.utils.get_check_rand_int">
<code class="highlight language-python">
get_check_rand_int<span class="p">(</span><span class="n">seed</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>Check the value passed of a seed, make sure it's an int, if 0, get a random seed</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>seed</code></td>
<td><code>int</code></td>
<td>
<p>integer to check or replace with a seed</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>int</code></td>
<td>
<p>validated seed</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>titan/utils.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">get_check_rand_int</span><span class="p">(</span><span class="n">seed</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    Check the value passed of a seed, make sure it's an int, if 0, get a random seed</span>

<span class="sd">    args:</span>
<span class="sd">        seed: integer to check or replace with a seed</span>

<span class="sd">    returns:</span>
<span class="sd">        validated seed</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">int</span> <span class="ow">or</span> <span class="n">seed</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Random seed must be positive integer"</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">seed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">seed</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="titan.utils.get_param_from_path">
<code class="highlight language-python">
get_param_from_path<span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">param_path</span><span class="p">,</span> <span class="n">delimiter</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>Given a params object and a delimited path, get the leaf of the params tree
and the last key to access it</p>
<details class="quote">
<summary>Source code in <code>titan/utils.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">get_param_from_path</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">param_path</span><span class="p">,</span> <span class="n">delimiter</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Given a params object and a delimited path, get the leaf of the params tree</span>
<span class="sd">    and the last key to access it</span>
<span class="sd">    """</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">param_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">delimiter</span><span class="p">)</span>
    <span class="n">path_params</span> <span class="o">=</span> <span class="n">params</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">path</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">path_params</span> <span class="o">=</span> <span class="n">path_params</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">path_params</span><span class="p">,</span> <span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="titan.utils.memo">
<code class="highlight language-python">
memo<span class="p">(</span><span class="n">f</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>Decorator to memoize a function
(caches results given args, only use if deterministic)</p>
<details class="quote">
<summary>Source code in <code>titan/utils.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">memo</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Decorator to memoize a function</span>
<span class="sd">    (caches results given args, only use if deterministic)</span>
<span class="sd">    """</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="o">*</span><span class="n">arg</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cache</span><span class="p">:</span>
            <span class="n">cache</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">arg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cache</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">wrap</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="titan.utils.override_param">
<code class="highlight language-python">
override_param<span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">param_path</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">'|'</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>Given the params and a parameter path in the format prep|target, change the
current value to new value</p>
<details class="quote">
<summary>Source code in <code>titan/utils.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">override_param</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">param_path</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">"|"</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Given the params and a parameter path in the format prep|target, change the</span>
<span class="sd">    current value to new value</span>
<span class="sd">    """</span>
    <span class="n">override_item</span><span class="p">,</span> <span class="n">last_key</span> <span class="o">=</span> <span class="n">get_param_from_path</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">param_path</span><span class="p">,</span> <span class="n">delimiter</span><span class="p">)</span>

    <span class="n">old_val</span> <span class="o">=</span> <span class="n">override_item</span><span class="p">[</span><span class="n">last_key</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"overriding - </span><span class="si">{</span><span class="n">param_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">old_val</span><span class="si">}</span><span class="s2"> =&gt; </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">override_item</span><span class="p">[</span><span class="n">last_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="titan.utils.poisson">
<code class="highlight language-python">
poisson<span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">np_rand</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>Mirrors scipy poisson.rvs function as used in code</p>
<details class="quote">
<summary>Source code in <code>titan/utils.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">poisson</span><span class="p">(</span><span class="n">mu</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np_rand</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Mirrors scipy poisson.rvs function as used in code</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">np_rand</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="titan.utils.safe_dist">
<code class="highlight language-python">
safe_dist<span class="p">(</span><span class="n">dist_info</span><span class="p">,</span> <span class="n">rand_gen</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>Draw a value from a distribution as defined in <code>dist_info</code>.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>dist_info</code></td>
<td><code>ObjMap</code></td>
<td>
<p>a definition of a distribution to use [params.classes.distributions]</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>rand_gen</code></td>
<td><code></code></td>
<td>
<p>random number generator</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Union[int, float]</code></td>
<td>
<p>a value drawn from the distribution</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>titan/utils.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">safe_dist</span><span class="p">(</span><span class="n">dist_info</span><span class="p">:</span> <span class="n">ObjMap</span><span class="p">,</span> <span class="n">rand_gen</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
    <span class="sd">"""</span>
<span class="sd">    Draw a value from a distribution as defined in `dist_info`.</span>

<span class="sd">    args:</span>
<span class="sd">        dist_info: a definition of a distribution to use [params.classes.distributions]</span>
<span class="sd">        rand_gen: random number generator</span>

<span class="sd">    returns:</span>
<span class="sd">        a value drawn from the distribution</span>
<span class="sd">    """</span>
    <span class="c1"># gather arguments</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dist_info</span><span class="o">.</span><span class="n">vars</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">dist_info</span><span class="o">.</span><span class="n">vars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">type_caster</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">dist_info</span><span class="o">.</span><span class="n">vars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">value_type</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">type_caster</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

    <span class="n">dist_type</span> <span class="o">=</span> <span class="n">dist_info</span><span class="o">.</span><span class="n">dist_type</span>

    <span class="k">try</span><span class="p">:</span>  <span class="c1"># does dist exist in numpy?</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rand_gen</span><span class="p">,</span> <span class="n">dist_type</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">dist</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>  <span class="c1"># does dist exist in distributions.py</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">distributions</span><span class="p">,</span> <span class="n">dist_type</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">dist</span><span class="p">(</span><span class="n">rand_gen</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Distribution type </span><span class="si">{</span><span class="n">dist_type</span><span class="si">}</span><span class="s2"> not found!"</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">"__iter__"</span><span class="p">):</span>  <span class="c1"># check if value is any type of sequence</span>
        <span class="k">return</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">value</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="titan.utils.safe_divide">
<code class="highlight language-python">
safe_divide<span class="p">(</span><span class="n">numerator</span><span class="p">,</span> <span class="n">denominator</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>Divide two numbers, but default 0 if denominator is 0, otherwise divide as normal.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>numerator</code></td>
<td><code>int</code></td>
<td>
<p>number being divided</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>denominator</code></td>
<td><code>int</code></td>
<td>
<p>number doing the dividing</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>float</code></td>
<td>
<p>resulting number</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>titan/utils.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">safe_divide</span><span class="p">(</span><span class="n">numerator</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">denominator</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    Divide two numbers, but default 0 if denominator is 0, otherwise divide as normal.</span>

<span class="sd">    args:</span>
<span class="sd">        numerator: number being divided</span>
<span class="sd">        denominator: number doing the dividing</span>

<span class="sd">    returns:</span>
<span class="sd">        resulting number</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">denominator</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">numerator</span> <span class="o">/</span> <span class="n">denominator</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="titan.utils.safe_random_choice">
<code class="highlight language-python">
safe_random_choice<span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">rand_gen</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>Return None or a random choice from a collection of items</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>seq</code></td>
<td><code>Collection[~T]</code></td>
<td>
<p>collection to select a random item from</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>rand_gen</code></td>
<td><code></code></td>
<td>
<p>random number generator</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>weights</code></td>
<td><code></code></td>
<td>
<p>an optional collection of weights to use instead of a uniform distribution</p>
</td>
<td><code>None</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Optional[~T]</code></td>
<td>
<p>an item, or <code>None</code> if the collection is empty</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>titan/utils.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">safe_random_choice</span><span class="p">(</span><span class="n">seq</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="n">T</span><span class="p">],</span> <span class="n">rand_gen</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
    <span class="sd">"""</span>
<span class="sd">    Return None or a random choice from a collection of items</span>

<span class="sd">    args:</span>
<span class="sd">        seq: collection to select a random item from</span>
<span class="sd">        rand_gen: random number generator</span>
<span class="sd">        weights: an optional collection of weights to use instead of a uniform distribution</span>

<span class="sd">    returns:</span>
<span class="sd">        an item, or `None` if the collection is empty</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">seq</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>

    <span class="n">choices</span> <span class="o">=</span> <span class="n">rand_gen</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="titan.utils.safe_shuffle">
<code class="highlight language-python">
safe_shuffle<span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">rand_gen</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>Return None or a shuffled sequence</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>seq</code></td>
<td><code>Collection[~T]</code></td>
<td>
<p>collection to shuffle</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>rand_gen</code></td>
<td><code></code></td>
<td>
<p>random number generator</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Optional[Collection[~T]]</code></td>
<td>
<p>shuffled sequence, or <code>None</code> if empty</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>titan/utils.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">safe_shuffle</span><span class="p">(</span><span class="n">seq</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="n">T</span><span class="p">],</span> <span class="n">rand_gen</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Collection</span><span class="p">[</span><span class="n">T</span><span class="p">]]:</span>
    <span class="sd">"""</span>
<span class="sd">    Return None or a shuffled sequence</span>

<span class="sd">    args:</span>
<span class="sd">        seq: collection to shuffle</span>
<span class="sd">        rand_gen: random number generator</span>

<span class="sd">    returns:</span>
<span class="sd">        shuffled sequence, or `None` if empty</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">seq</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
            <span class="n">rand_gen</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">seq</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">seq</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rand_gen</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">seq</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="titan.utils.scale_param">
<code class="highlight language-python">
scale_param<span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">param_path</span><span class="p">,</span> <span class="n">scalar</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">'|'</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>Given the params and a parameter path in the format prep|target, scale the
current value by the scalar</p>
<details class="quote">
<summary>Source code in <code>titan/utils.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">scale_param</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">param_path</span><span class="p">,</span> <span class="n">scalar</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">"|"</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Given the params and a parameter path in the format prep|target, scale the</span>
<span class="sd">    current value by the scalar</span>
<span class="sd">    """</span>
    <span class="n">scaling_item</span><span class="p">,</span> <span class="n">last_key</span> <span class="o">=</span> <span class="n">get_param_from_path</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">param_path</span><span class="p">,</span> <span class="n">delimiter</span><span class="p">)</span>

    <span class="n">old_val</span> <span class="o">=</span> <span class="n">scaling_item</span><span class="p">[</span><span class="n">last_key</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"scaling - </span><span class="si">{</span><span class="n">param_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">old_val</span><span class="si">}</span><span class="s2"> =&gt; </span><span class="si">{</span><span class="n">old_val</span> <span class="o">*</span> <span class="n">scalar</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">scaling_item</span><span class="p">[</span><span class="n">last_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_val</span> <span class="o">*</span> <span class="n">scalar</span>
</code></pre>
</div>
</details>
</div>
</div>
</div>
</div>
</div>
<h2 id="probability-distributions">Probability Distributions</h2>
<div class="doc doc-object doc-module">
<div class="doc doc-contents first">
<p>This file contains distributions that don't exist in numpy.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="titan.distributions.pert">
<code class="highlight language-python">
pert<span class="p">(</span><span class="n">np_random</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">temperature</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>A pert distribution, inspired by <a href="https://github.com/tensorflow/probability/blob/c833ee5cd9f60f3257366b25447b9e50210b0590/tensorflow_probability/python/distributions/pert.py#L137">tensorflow</a></p>
<p>arguments must be so that:</p>
<ul>
<li>low &lt; peak &lt; high</li>
<li>temperature &gt; 0</li>
</ul>
<p>The support is <code>[low, high]</code>.  The <code>peak</code> must fit in that interval:
  <code>low &lt; peak &lt; high</code>.  The <code>temperature</code> is a positive parameter that
  controls the shape of the distribution. Higher values yield a sharper peak.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>np_random</code></td>
<td><code></code></td>
<td>
<p>random number generator (used to get beta)</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>low</code></td>
<td><code></code></td>
<td>
<p>distribution low value</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>peak</code></td>
<td><code></code></td>
<td>
<p>modal point in distribution</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>high</code></td>
<td><code></code></td>
<td>
<p>distribution high value</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>temperature</code></td>
<td><code></code></td>
<td>
<p>scaling factor</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>titan/distributions.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">pert</span><span class="p">(</span><span class="n">np_random</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">temperature</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    A pert distribution, inspired by [tensorflow](https://github.com/tensorflow/probability/blob/c833ee5cd9f60f3257366b25447b9e50210b0590/tensorflow_probability/python/distributions/pert.py#L137)</span>

<span class="sd">    arguments must be so that:</span>

<span class="sd">    * low &lt; peak &lt; high</span>
<span class="sd">    * temperature &gt; 0</span>

<span class="sd">    The support is `[low, high]`.  The `peak` must fit in that interval:</span>
<span class="sd">      `low &lt; peak &lt; high`.  The `temperature` is a positive parameter that</span>
<span class="sd">      controls the shape of the distribution. Higher values yield a sharper peak.</span>

<span class="sd">    args:</span>
<span class="sd">        np_random: random number generator (used to get beta)</span>
<span class="sd">        low: distribution low value</span>
<span class="sd">        peak: modal point in distribution</span>
<span class="sd">        high: distribution high value</span>
<span class="sd">        temperature: scaling factor</span>
<span class="sd">    """</span>
    <span class="k">assert</span> <span class="n">low</span> <span class="o">&lt;</span> <span class="n">peak</span> <span class="o">&lt;</span> <span class="n">high</span>
    <span class="k">assert</span> <span class="n">temperature</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="n">scale</span> <span class="o">=</span> <span class="n">high</span> <span class="o">-</span> <span class="n">low</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">temperature</span> <span class="o">*</span> <span class="p">(</span><span class="n">peak</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span> <span class="o">/</span> <span class="n">scale</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">temperature</span> <span class="o">*</span> <span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">peak</span><span class="p">)</span> <span class="o">/</span> <span class="n">scale</span>
    <span class="k">return</span> <span class="n">low</span> <span class="o">+</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">np_random</span><span class="o">.</span><span class="n">beta</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="titan.distributions.set_value">
<code class="highlight language-python">
set_value<span class="p">(</span><span class="n">np_random</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>A distribution that always returns the value passed</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>np_random</code></td>
<td><code></code></td>
<td>
<p>random number generator (to conform to distribution interface)</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>value</code></td>
<td><code></code></td>
<td>
<p>value to return</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>titan/distributions.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">set_value</span><span class="p">(</span><span class="n">np_random</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    A distribution that always returns the value passed</span>

<span class="sd">    args:</span>
<span class="sd">        np_random: random number generator (to conform to distribution interface)</span>
<span class="sd">        value: value to return</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">value</span>
</code></pre>
</div>
</details>
</div>
</div>
</div>
</div>
</div>
<h2 id="params">Params</h2>
<div class="doc doc-object doc-module">
<div class="doc doc-contents first">
<div class="doc doc-children">
<div class="doc doc-object doc-class">
<h3 class="doc doc-heading" id="titan.parse_params.ObjMap">
<code>ObjMap</code>
</h3>
<div class="doc doc-contents">
<p>A dictionary-like class which allows accessing members either using standard
dictionary notation or dots.  Note the hash function is hard-coded - beware.</p>
<div class="doc doc-children">
<div class="doc doc-object doc-method">
<h4 class="doc doc-heading" id="titan.parse_params.ObjMap.__hash__">
<code class="highlight language-python">
__hash__<span class="p">(</span><span class="bp">self</span><span class="p">)</span> </code>
<span class="doc doc-properties">
<small class="doc doc-property doc-property-special"><code>special</code></small>
</span>
</h4>
<div class="doc doc-contents">
<p>Return hash(self).</p>
<details class="quote">
<summary>Source code in <code>titan/parse_params.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">1234567890</span>
</code></pre>
</div>
</details>
</div>
</div>
</div>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="titan.parse_params.build_yaml">
<code class="highlight language-python">
build_yaml<span class="p">(</span><span class="n">path</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>Read in a yaml or folder of yamls into a dictionary.</p>
<details class="quote">
<summary>Source code in <code>titan/parse_params.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">build_yaml</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Read in a yaml or folder of yamls into a dictionary.</span>
<span class="sd">    """</span>
    <span class="n">yml</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">".yml"</span> <span class="ow">in</span> <span class="n">file</span> <span class="ow">or</span> <span class="s2">".yaml"</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">this_yml</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="n">yml</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">this_yml</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">assert</span> <span class="s2">".yml"</span> <span class="ow">in</span> <span class="n">path</span> <span class="ow">or</span> <span class="s2">".yaml"</span> <span class="ow">in</span> <span class="n">path</span>
            <span class="n">this_yml</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">yml</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">this_yml</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">yml</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="titan.parse_params.check_item">
<code class="highlight language-python">
check_item<span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">key_path</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pops</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>Checks if an item meets the requirements of the field's definition.</p>
<details class="quote">
<summary>Source code in <code>titan/parse_params.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">check_item</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">key_path</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pops</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Checks if an item meets the requirements of the field's definition.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="s2">"min"</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">val</span> <span class="o">&gt;=</span> <span class="n">d</span><span class="p">[</span><span class="s2">"min"</span><span class="p">],</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2"> must be greater than </span><span class="si">{</span><span class="n">d</span><span class="p">[</span><span class="s1">'min'</span><span class="p">]</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">key_path</span><span class="si">}</span><span class="s2">]"</span>
    <span class="k">if</span> <span class="s2">"max"</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">val</span> <span class="o">&lt;=</span> <span class="n">d</span><span class="p">[</span><span class="s2">"max"</span><span class="p">],</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2"> must be less than </span><span class="si">{</span><span class="n">d</span><span class="p">[</span><span class="s1">'max'</span><span class="p">]</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">key_path</span><span class="si">}</span><span class="s2">]"</span>
    <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"int"</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2"> must be an integer [</span><span class="si">{</span><span class="n">key_path</span><span class="si">}</span><span class="s2">]"</span>
    <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"float"</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2"> must be a float [</span><span class="si">{</span><span class="n">key_path</span><span class="si">}</span><span class="s2">]"</span>
    <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"boolean"</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2"> must be a bool [</span><span class="si">{</span><span class="n">key_path</span><span class="si">}</span><span class="s2">]"</span>
    <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"enum"</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">"values"</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">"values"</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s2">"class"</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">pops</span><span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s2">"class"</span><span class="p">]]</span>
        <span class="k">assert</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">values</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2"> not in </span><span class="si">{</span><span class="n">values</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">key_path</span><span class="si">}</span><span class="s2">]"</span>
    <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"array"</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">"values"</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">"values"</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s2">"class"</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">pops</span><span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s2">"class"</span><span class="p">]]</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2"> must be an array [</span><span class="si">{</span><span class="n">key_path</span><span class="si">}</span><span class="s2">]"</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">values</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">val</span><span class="p">),</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2"> not in </span><span class="si">{</span><span class="n">values</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">key_path</span><span class="si">}</span><span class="s2">]"</span>
    <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"keys"</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2"> must be an array of keys [</span><span class="si">{</span><span class="n">key_path</span><span class="si">}</span><span class="s2">]"</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">keys</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">val</span><span class="p">),</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">keys</span><span class="si">}</span><span class="s2"> not in </span><span class="si">{</span><span class="n">keys</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">key_path</span><span class="si">}</span><span class="s2">]"</span>
    <span class="k">return</span> <span class="n">val</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="titan.parse_params.check_params">
<code class="highlight language-python">
check_params<span class="p">(</span><span class="n">params</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>Consistency checks for param populations</p>
<details class="quote">
<summary>Source code in <code>titan/parse_params.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">check_params</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Consistency checks for param populations</span>
<span class="sd">    """</span>
    <span class="n">race_pop</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">race</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">races</span><span class="p">:</span>
        <span class="n">r_dems</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">demographics</span><span class="p">[</span><span class="n">race</span><span class="p">]</span>
        <span class="n">race_pop</span> <span class="o">+=</span> <span class="n">r_dems</span><span class="o">.</span><span class="n">ppl</span>
        <span class="n">sex_type_pop</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">st</span><span class="p">,</span> <span class="n">st_dems</span> <span class="ow">in</span> <span class="n">r_dems</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">st</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">sex_types</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">sex_type_pop</span> <span class="o">+=</span> <span class="n">st_dems</span><span class="o">.</span><span class="n">ppl</span>

        <span class="k">assert</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span>
            <span class="n">sex_type_pop</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">abs_tol</span><span class="o">=</span><span class="mf">0.001</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">"ppl of </span><span class="si">{</span><span class="n">race</span><span class="si">}</span><span class="s2">'s sex_types must add to 1. Currently adding to </span><span class="si">{</span><span class="n">sex_type_pop</span><span class="si">}</span><span class="s2">"</span>

    <span class="k">assert</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">race_pop</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">abs_tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">),</span> <span class="sa">f</span><span class="s2">"ppl of races must add to 1"</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="titan.parse_params.create_params">
<code class="highlight language-python">
create_params<span class="p">(</span><span class="n">setting_path</span><span class="p">,</span> <span class="n">param_path</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">use_base</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error_on_unused</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>Entry function - given the path to the setting, params, output directory and whether
or not to use the base setting. Parse and create a params (ObjMap) object.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>setting_path</code></td>
<td><code>Optional[str]</code></td>
<td>
<p>path to a settings file or directory or <code>None</code></p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>param_path</code></td>
<td><code>str</code></td>
<td>
<p>path to parameter file or directory</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>outdir</code></td>
<td><code>str</code></td>
<td>
<p>path to directory where computed params will be saved</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>use_base</code></td>
<td><code>bool</code></td>
<td>
<p>whether to use the base setting</p>
</td>
<td><code>True</code></td>
</tr>
<tr>
<td><code>error_on_unused</code></td>
<td><code>bool</code></td>
<td>
<p>throw a hard error if there are unused parameters, otherwise warnings are only printed</p>
</td>
<td><code>False</code></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ObjMap</code></td>
<td>
<p>computed/validated model paramters with defaults filled in where needed</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>titan/parse_params.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">create_params</span><span class="p">(</span>
    <span class="n">setting_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">param_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">outdir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">use_base</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">error_on_unused</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ObjMap</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    Entry function - given the path to the setting, params, output directory and whether</span>
<span class="sd">    or not to use the base setting. Parse and create a params (ObjMap) object.</span>

<span class="sd">    args:</span>
<span class="sd">        setting_path: path to a settings file or directory or `None`</span>
<span class="sd">        param_path: path to parameter file or directory</span>
<span class="sd">        outdir: path to directory where computed params will be saved</span>
<span class="sd">        use_base: whether to use the base setting</span>
<span class="sd">        error_on_unused: throw a hard error if there are unused parameters, otherwise warnings are only printed</span>

<span class="sd">    returns:</span>
<span class="sd">        computed/validated model paramters with defaults filled in where needed</span>
<span class="sd">    """</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">getsourcefile</span><span class="p">(</span><span class="n">warn_unused_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"can't find where I am in the code?"</span><span class="p">)</span>

    <span class="n">root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="s2">"params"</span><span class="p">)</span>

    <span class="n">defs</span> <span class="o">=</span> <span class="n">build_yaml</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">build_yaml</span><span class="p">(</span><span class="n">param_path</span><span class="p">)</span>

    <span class="c1"># merge setting and params</span>
    <span class="k">if</span> <span class="n">setting_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">setting</span> <span class="o">=</span> <span class="n">build_yaml</span><span class="p">(</span><span class="n">setting_path</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">setting</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">use_base</span><span class="p">:</span>
        <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="s2">".."</span><span class="p">,</span> <span class="s2">"settings"</span><span class="p">,</span> <span class="s2">"base"</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">build_yaml</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

    <span class="n">pops</span> <span class="o">=</span> <span class="n">parse_classes</span><span class="p">(</span><span class="n">defs</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    <span class="n">parsed</span> <span class="o">=</span> <span class="n">parse_params</span><span class="p">(</span><span class="n">defs</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="n">pops</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">"params.yml"</span><span class="p">),</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">parsed</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="n">parsed</span> <span class="o">=</span> <span class="n">ObjMap</span><span class="p">(</span><span class="n">parsed</span><span class="p">)</span>
    <span class="n">check_params</span><span class="p">(</span><span class="n">parsed</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Checking for unused parameters..."</span><span class="p">)</span>
    <span class="n">num_unused</span> <span class="o">=</span> <span class="n">warn_unused_params</span><span class="p">(</span><span class="n">parsed</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">num_unused</span><span class="si">}</span><span class="s2"> unused parameters found"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">error_on_unused</span><span class="p">:</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">num_unused</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="p">),</span> <span class="s2">"There are unused parameters passed to the model (see print statements)"</span>

    <span class="k">return</span> <span class="n">parsed</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="titan.parse_params.get_bins">
<code class="highlight language-python">
get_bins<span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">key_path</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">pops</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>Get and validate a type == bin definition</p>
<details class="quote">
<summary>Source code in <code>titan/parse_params.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">get_bins</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">key_path</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">pops</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Get and validate a type == bin definition</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">d</span><span class="p">[</span><span class="s2">"default"</span><span class="p">]</span>

    <span class="n">bins</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">"default"</span><span class="p">],</span> <span class="n">param</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

    <span class="n">parsed_bins</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="nb">bin</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">bins</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">int</span><span class="p">(</span><span class="nb">bin</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"Bins must be integers"</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">defn</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s2">"fields"</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">assert</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">val</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2"> must be in </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">key_path</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="nb">bin</span><span class="si">}</span><span class="s2">]"</span>
            <span class="n">val</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">check_item</span><span class="p">(</span>
                <span class="n">val</span><span class="p">[</span><span class="n">field</span><span class="p">],</span> <span class="n">defn</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">key_path</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="nb">bin</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">pops</span><span class="o">=</span><span class="n">pops</span>
            <span class="p">)</span>

        <span class="n">parsed_bins</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">bin</span><span class="p">)]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">return</span> <span class="n">parsed_bins</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="titan.parse_params.get_defn">
<code class="highlight language-python">
get_defn<span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">key_path</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">pops</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>Get and validate a type == definition definition</p>
<details class="quote">
<summary>Source code in <code>titan/parse_params.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">get_defn</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">key_path</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">pops</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Get and validate a type == definition definition</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param</span> <span class="ow">or</span> <span class="n">param</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="p">{}:</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">"default"</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="c1"># check definitions</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">parsed</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">defn</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s2">"fields"</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">"default"</span> <span class="ow">in</span> <span class="n">defn</span><span class="p">:</span>
                    <span class="n">val</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">defn</span><span class="p">[</span><span class="s2">"default"</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">val</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2"> must be in </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">key_path</span><span class="si">}</span><span class="s2">]"</span>
            <span class="n">val</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">check_item</span><span class="p">(</span>
                <span class="n">val</span><span class="p">[</span><span class="n">field</span><span class="p">],</span> <span class="n">defn</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">key_path</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="n">parsed</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">pops</span><span class="o">=</span><span class="n">pops</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">parsed</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="titan.parse_params.get_item">
<code class="highlight language-python">
get_item<span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">key_path</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">pops</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>Get and check item from the params, falling back on the definitions default.</p>
<details class="quote">
<summary>Source code in <code>titan/parse_params.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">get_item</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">key_path</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">pops</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Get and check item from the params, falling back on the definitions default.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">param</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">check_item</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">key_path</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">pops</span><span class="o">=</span><span class="n">pops</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">d</span><span class="p">[</span><span class="s2">"default"</span><span class="p">]</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="titan.parse_params.merge">
<code class="highlight language-python">
merge<span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>return new merged dict of dicts</p>
<details class="quote">
<summary>Source code in <code>titan/parse_params.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">):</span>
    <span class="sd">"""return new merged dict of dicts"""</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Mapping</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">d2</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Mapping</span>
    <span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d1</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">d2</span><span class="p">:</span>
                <span class="n">d2</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">d2</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="n">d3</span> <span class="o">=</span> <span class="n">d1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">d3</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">d2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">d3</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">d2</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="titan.parse_params.parse_classes">
<code class="highlight language-python">
parse_classes<span class="p">(</span><span class="n">defs</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>Parse the classes definition first as it is needed in parsing the full params.</p>
<details class="quote">
<summary>Source code in <code>titan/parse_params.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">parse_classes</span><span class="p">(</span><span class="n">defs</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Parse the classes definition first as it is needed in parsing the full params.</span>
<span class="sd">    """</span>
    <span class="c1"># add sex types to populations</span>
    <span class="k">if</span> <span class="s2">"sex_types"</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"classes"</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">"classes"</span><span class="p">][</span><span class="s2">"populations"</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">"classes"</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">"populations"</span><span class="p">,</span> <span class="n">defs</span><span class="p">[</span><span class="s2">"classes"</span><span class="p">][</span><span class="s2">"populations"</span><span class="p">][</span><span class="s2">"default"</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">"classes"</span><span class="p">][</span><span class="s2">"sex_types"</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="n">sex_type_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">defs</span><span class="p">[</span><span class="s2">"classes"</span><span class="p">][</span><span class="s2">"sex_types"</span><span class="p">][</span><span class="s2">"default"</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="n">defs</span><span class="p">[</span><span class="s2">"classes"</span><span class="p">][</span><span class="s2">"populations"</span><span class="p">][</span><span class="s2">"default"</span><span class="p">]</span> <span class="o">+=</span> <span class="n">sex_type_keys</span>
    <span class="n">defs</span><span class="p">[</span><span class="s2">"classes"</span><span class="p">][</span><span class="s2">"populations"</span><span class="p">][</span><span class="s2">"values"</span><span class="p">]</span> <span class="o">+=</span> <span class="n">sex_type_keys</span>

    <span class="k">return</span> <span class="n">parse_params</span><span class="p">(</span><span class="n">defs</span><span class="p">[</span><span class="s2">"classes"</span><span class="p">],</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"classes"</span><span class="p">,</span> <span class="p">{}),</span> <span class="s2">""</span><span class="p">,</span> <span class="p">{})</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="titan.parse_params.parse_params">
<code class="highlight language-python">
parse_params<span class="p">(</span><span class="n">defs</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">key_path</span><span class="p">,</span> <span class="n">pops</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>Recursively parse the passed params, using the definitions to validate
and provide defaults.</p>
<details class="quote">
<summary>Source code in <code>titan/parse_params.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">parse_params</span><span class="p">(</span><span class="n">defs</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">key_path</span><span class="p">,</span> <span class="n">pops</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Recursively parse the passed params, using the definitions to validate</span>
<span class="sd">    and provide defaults.</span>
<span class="sd">    """</span>
    <span class="n">parsed</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># params is a scalar, return it</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">params</span>

    <span class="c1"># handles case of bin as direct default item</span>
    <span class="k">if</span> <span class="s2">"default"</span> <span class="ow">in</span> <span class="n">defs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">defs</span><span class="p">[</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"bin"</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">get_bins</span><span class="p">(</span><span class="s2">"dummy"</span><span class="p">,</span> <span class="n">defs</span><span class="p">,</span> <span class="n">key_path</span><span class="p">,</span> <span class="p">{</span><span class="s2">"dummy"</span><span class="p">:</span> <span class="n">params</span><span class="p">},</span> <span class="n">pops</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">defs</span><span class="p">[</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"definition"</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">get_defn</span><span class="p">(</span><span class="s2">"dummy"</span><span class="p">,</span> <span class="n">defs</span><span class="p">,</span> <span class="n">key_path</span><span class="p">,</span> <span class="p">{</span><span class="s2">"dummy"</span><span class="p">:</span> <span class="n">params</span><span class="p">},</span> <span class="n">pops</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">defs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># assumes all v are dicts, as otherwise it would have returned</span>
        <span class="k">if</span> <span class="s2">"default"</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"sub-dict"</span><span class="p">:</span>
                <span class="n">parsed</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">field</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s2">"keys"</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">pops</span><span class="p">[</span><span class="n">field</span><span class="p">]:</span>
                    <span class="n">parsed</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">val</span><span class="p">]</span> <span class="o">=</span> <span class="n">parse_params</span><span class="p">(</span>
                        <span class="n">v</span><span class="p">[</span><span class="s2">"default"</span><span class="p">],</span>
                        <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">{}),</span>
                        <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">key_path</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
                        <span class="n">pops</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s2">"keys"</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">field2</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s2">"keys"</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">val2</span> <span class="ow">in</span> <span class="n">pops</span><span class="p">[</span><span class="n">field2</span><span class="p">]:</span>
                            <span class="n">parsed</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">val</span><span class="p">][</span><span class="n">val2</span><span class="p">]</span> <span class="o">=</span> <span class="n">parse_params</span><span class="p">(</span>
                                <span class="n">v</span><span class="p">[</span><span class="s2">"default"</span><span class="p">],</span>
                                <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">val2</span><span class="p">,</span> <span class="p">{}),</span>
                                <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">key_path</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">val2</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
                                <span class="n">pops</span><span class="p">,</span>
                            <span class="p">)</span>

            <span class="k">elif</span> <span class="n">v</span><span class="p">[</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"bin"</span><span class="p">:</span>
                <span class="n">parsed</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_bins</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">key_path</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pops</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">v</span><span class="p">[</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"definition"</span><span class="p">:</span>
                <span class="n">parsed</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_defn</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">key_path</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pops</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parsed</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_item</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">key_path</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pops</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parsed</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">parse_params</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">{}),</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">key_path</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">pops</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">parsed</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="titan.parse_params.warn_unused_params">
<code class="highlight language-python">
warn_unused_params<span class="p">(</span><span class="n">parsed</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">key_path</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>Compare the original params to what was parsed and print warnings for any original
params that are unused in the final parsed parasms. This excludes unused params
from base as those are unavoidable.</p>
<details class="quote">
<summary>Source code in <code>titan/parse_params.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">warn_unused_params</span><span class="p">(</span><span class="n">parsed</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">key_path</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Compare the original params to what was parsed and print warnings for any original</span>
<span class="sd">    params that are unused in the final parsed parasms. This excludes unused params</span>
<span class="sd">    from base as those are unavoidable.</span>
<span class="sd">    """</span>
    <span class="c1"># both values, return</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parsed</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">count</span>
    <span class="c1"># params has keys, parsed doesn't</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parsed</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="n">key_path</span><span class="si">}</span><span class="s2">] has unused params: </span><span class="si">{</span><span class="n">params</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">count</span>
    <span class="c1"># parsed has keys, params doesn't</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="n">key_path</span><span class="si">}</span><span class="s2">] has sub-keys, got unused params: </span><span class="si">{</span><span class="n">params</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">count</span>

    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">parsed</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="n">warn_unused_params</span><span class="p">(</span>
                <span class="n">parsed</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">base</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">{}),</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">key_path</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">"</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">base</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="n">key_path</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">] is unused"</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">count</span>
</code></pre>
</div>
</details>
</div>
</div>
</div>
</div>
</div>
<h2 id="partnering">Partnering</h2>
<div class="doc doc-object doc-module">
<div class="doc doc-contents first">
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="titan.partnering.get_mean_rel_duration">
<code class="highlight language-python">
get_mean_rel_duration<span class="p">(</span><span class="n">params</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>Find the average partnership duration by bond type</p>
<details class="quote">
<summary>Source code in <code>titan/partnering.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">get_mean_rel_duration</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">ObjMap</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Find the average partnership duration by bond type</span>
<span class="sd">    """</span>
    <span class="n">mean_rel_duration</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">partnership</span><span class="o">.</span><span class="n">duration</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">partnership</span><span class="o">.</span><span class="n">duration</span><span class="p">[</span><span class="n">bond</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">"bins"</span><span class="p">:</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">dur_bins</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">partnership</span><span class="o">.</span><span class="n">duration</span><span class="p">[</span><span class="n">bond</span><span class="p">]</span><span class="o">.</span><span class="n">bins</span>
            <span class="k">for</span> <span class="n">bins</span> <span class="ow">in</span> <span class="n">dur_bins</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bins</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dur_bins</span><span class="p">[</span><span class="n">bins</span><span class="p">]</span><span class="o">.</span><span class="n">prob</span> <span class="o">-</span> <span class="n">dur_bins</span><span class="p">[</span><span class="n">bins</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">prob</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dur_bins</span><span class="p">[</span><span class="n">bins</span><span class="p">]</span><span class="o">.</span><span class="n">prob</span><span class="p">)</span>
                <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">([</span><span class="n">dur_bins</span><span class="p">[</span><span class="n">bins</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">,</span> <span class="n">dur_bins</span><span class="p">[</span><span class="n">bins</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">]))</span>
            <span class="n">mean_rel_duration</span><span class="p">[</span><span class="n">bond</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mean_rel_duration</span><span class="p">[</span><span class="n">bond</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">partnership</span><span class="o">.</span><span class="n">duration</span><span class="p">[</span>
                <span class="n">bond</span>
            <span class="p">]</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">mean</span>

    <span class="k">return</span> <span class="n">mean_rel_duration</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="titan.partnering.get_partnership_duration">
<code class="highlight language-python">
get_partnership_duration<span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">rand_gen</span><span class="p">,</span> <span class="n">bond_type</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>Get duration of a relationship drawn from bins or a distribution per the params [params.partnership.duration]</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>params</code></td>
<td><code>ObjMap</code></td>
<td>
<p>model parameters</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>rand_gen</code></td>
<td><code></code></td>
<td>
<p>random number generator</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>bond_type</code></td>
<td><code></code></td>
<td>
<p>type of bond for the relationship whose duration is being determined</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>int</code></td>
<td>
<p>number of time steps the partnership should endure</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>titan/partnering.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">get_partnership_duration</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">ObjMap</span><span class="p">,</span> <span class="n">rand_gen</span><span class="p">,</span> <span class="n">bond_type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    Get duration of a relationship drawn from bins or a distribution per the params [params.partnership.duration]</span>

<span class="sd">    args:</span>
<span class="sd">        params: model parameters</span>
<span class="sd">        rand_gen: random number generator</span>
<span class="sd">        bond_type: type of bond for the relationship whose duration is being determined</span>

<span class="sd">    returns:</span>
<span class="sd">        number of time steps the partnership should endure</span>
<span class="sd">    """</span>

    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">partnership</span><span class="o">.</span><span class="n">duration</span><span class="p">[</span><span class="n">bond_type</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">"bins"</span><span class="p">:</span>
        <span class="n">dur_info</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">partnership</span><span class="o">.</span><span class="n">duration</span><span class="p">[</span><span class="n">bond_type</span><span class="p">]</span><span class="o">.</span><span class="n">bins</span>

        <span class="n">diceroll</span> <span class="o">=</span> <span class="n">rand_gen</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
        <span class="n">dur_bin</span> <span class="o">=</span> <span class="n">dur_info</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">diceroll</span> <span class="o">&lt;</span> <span class="n">dur_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">prob</span><span class="p">:</span>
                <span class="n">dur_bin</span> <span class="o">=</span> <span class="n">dur_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">break</span>

        <span class="n">duration</span> <span class="o">=</span> <span class="n">rand_gen</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">dur_bin</span><span class="o">.</span><span class="n">min</span><span class="p">,</span> <span class="n">dur_bin</span><span class="o">.</span><span class="n">max</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">partnership</span><span class="o">.</span><span class="n">duration</span><span class="p">[</span><span class="n">bond_type</span><span class="p">]</span><span class="o">.</span><span class="n">distribution</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">safe_dist</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">rand_gen</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">duration</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="titan.partnering.select_partner">
<code class="highlight language-python">
select_partner<span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">partnerable_agents</span><span class="p">,</span> <span class="n">sex_partners</span><span class="p">,</span> <span class="n">pwid_agents</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">rand_gen</span><span class="p">,</span> <span class="n">bond_type</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>Get a partner for the agent.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>agent</code></td>
<td><code>Agent</code></td>
<td>
<p>agent in need of a partner</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>partnerable_agents</code></td>
<td><code>Set[titan.agent.Agent]</code></td>
<td>
<p>agents that can be selected as a partner</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>sex_partners</code></td>
<td><code>Dict</code></td>
<td>
<p>mapping from sex_type to agents in the population that can sleep with that sex_type</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>pwid_agents</code></td>
<td><code>AgentSet</code></td>
<td>
<p>agents with <code>drug_type==="Inj"</code></p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>params</code></td>
<td><code>ObjMap</code></td>
<td>
<p>model parameters</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>rand_gen</code></td>
<td><code></code></td>
<td>
<p>random number generator</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>bond_type</code></td>
<td><code></code></td>
<td>
<p>type of relationship that is being formed with the partner</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Optional[titan.agent.Agent]</code></td>
<td>
<p>new partner or <code>None</code></p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>titan/partnering.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="k">def</span> <span class="nf">select_partner</span><span class="p">(</span>
    <span class="n">agent</span><span class="p">:</span> <span class="n">Agent</span><span class="p">,</span>
    <span class="n">partnerable_agents</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">Agent</span><span class="p">],</span>
    <span class="n">sex_partners</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="n">pwid_agents</span><span class="p">:</span> <span class="n">AgentSet</span><span class="p">,</span>
    <span class="n">params</span><span class="p">:</span> <span class="n">ObjMap</span><span class="p">,</span>
    <span class="n">rand_gen</span><span class="p">,</span>
    <span class="n">bond_type</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Agent</span><span class="p">]:</span>
    <span class="sd">"""</span>
<span class="sd">    Get a partner for the agent.</span>

<span class="sd">    args:</span>
<span class="sd">        agent : agent in need of a partner</span>
<span class="sd">        partnerable_agents: agents that can be selected as a partner</span>
<span class="sd">        sex_partners: mapping from sex_type to agents in the population that can sleep with that sex_type</span>
<span class="sd">        pwid_agents: agents with `drug_type==="Inj"`</span>
<span class="sd">        params: model parameters</span>
<span class="sd">        rand_gen: random number generator</span>
<span class="sd">        bond_type: type of relationship that is being formed with the partner</span>

<span class="sd">    returns:</span>
<span class="sd">        new partner or `None`</span>
<span class="sd">    """</span>

    <span class="k">def</span> <span class="nf">assort</span><span class="p">(</span><span class="n">eligible_partners</span><span class="p">,</span> <span class="n">assort_params</span><span class="p">):</span>
        <span class="n">partner_types</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">assort_params</span><span class="o">.</span><span class="n">partner_values</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">partner_weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">assort_params</span><span class="o">.</span><span class="n">partner_values</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">partner_types</span><span class="p">]</span>
        <span class="n">partner_type</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">safe_random_choice</span><span class="p">(</span>
            <span class="n">partner_types</span><span class="p">,</span> <span class="n">rand_gen</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">partner_weights</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">partner_type</span> <span class="o">==</span> <span class="s2">"__other__"</span><span class="p">:</span>
            <span class="c1"># remove all the specified (not selected) values and remove those</span>
            <span class="c1"># partners from the eligible set</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">partner_types</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span> <span class="o">!=</span> <span class="s2">"__other__"</span><span class="p">:</span>
                    <span class="n">eligible_partners</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="n">partner</span>
                        <span class="k">for</span> <span class="n">partner</span> <span class="ow">in</span> <span class="n">eligible_partners</span>
                        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">partner</span><span class="p">,</span> <span class="n">assort_params</span><span class="o">.</span><span class="n">attribute</span><span class="p">))</span> <span class="o">!=</span> <span class="n">p</span>
                    <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">eligible_partners</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">partner</span>
                <span class="k">for</span> <span class="n">partner</span> <span class="ow">in</span> <span class="n">eligible_partners</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">partner</span><span class="p">,</span> <span class="n">assort_params</span><span class="o">.</span><span class="n">attribute</span><span class="p">))</span> <span class="o">==</span> <span class="n">partner_type</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="n">eligible_partners</span>

    <span class="n">eligible</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">partnerable_agents</span><span class="p">)</span>
    <span class="n">eligible</span> <span class="o">-=</span> <span class="n">agent</span><span class="o">.</span><span class="n">get_partners</span><span class="p">()</span>
    <span class="n">eligible</span> <span class="o">-=</span> <span class="p">{</span><span class="n">agent</span><span class="p">}</span>

    <span class="n">acts_allowed</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">bond_types</span><span class="p">[</span><span class="n">bond_type</span><span class="p">]</span><span class="o">.</span><span class="n">acts_allowed</span>

    <span class="k">if</span> <span class="s2">"injection"</span> <span class="ow">in</span> <span class="n">acts_allowed</span><span class="p">:</span>
        <span class="n">eligible</span> <span class="o">&amp;=</span> <span class="n">pwid_agents</span><span class="o">.</span><span class="n">members</span>

    <span class="k">if</span> <span class="s2">"sex"</span> <span class="ow">in</span> <span class="n">acts_allowed</span><span class="p">:</span>
        <span class="n">eligible</span> <span class="o">&amp;=</span> <span class="n">sex_partners</span><span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">sex_type</span><span class="p">]</span>

    <span class="c1"># short circuit to avoid attempting to assort with no eligible partners</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">eligible</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">assort_mix</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">assort_def</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">assort_mix</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">assort_def</span><span class="o">.</span><span class="n">attribute</span><span class="p">)</span> <span class="o">==</span> <span class="n">assort_def</span><span class="o">.</span><span class="n">agent_value</span><span class="p">:</span>
                <span class="n">eligible</span> <span class="o">=</span> <span class="n">assort</span><span class="p">(</span><span class="n">eligible</span><span class="p">,</span> <span class="n">assort_def</span><span class="p">)</span>

    <span class="n">random_partner</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">safe_random_choice</span><span class="p">(</span><span class="n">eligible</span><span class="p">,</span> <span class="n">rand_gen</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">random_partner</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="titan.partnering.sex_possible">
<code class="highlight language-python">
sex_possible<span class="p">(</span><span class="n">agent_sex_type</span><span class="p">,</span> <span class="n">partner_sex_type</span><span class="p">,</span> <span class="n">sex_types</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>Determine if sex is possible.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>agent_sex_type</code></td>
<td><code>str</code></td>
<td>
<p>name of agent's sex type</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>partner_sex_type</code></td>
<td><code>str</code></td>
<td>
<p>name of partner's sex type</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>bool</code></td>
<td>
<p>whether sex is possible between agents of these sex types</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>titan/partnering.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="nd">@utils</span><span class="o">.</span><span class="n">memo</span>
<span class="k">def</span> <span class="nf">sex_possible</span><span class="p">(</span><span class="n">agent_sex_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">partner_sex_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sex_types</span><span class="p">:</span> <span class="n">ObjMap</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    Determine if sex is possible.</span>

<span class="sd">    args:</span>
<span class="sd">        agent_sex_type: name of agent's sex type</span>
<span class="sd">        partner_sex_type: name of partner's sex type</span>

<span class="sd">    returns:</span>
<span class="sd">        whether sex is possible between agents of these sex types</span>
<span class="sd">    """</span>

    <span class="c1"># Check input</span>
    <span class="k">if</span> <span class="n">agent_sex_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sex_types</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Invalid agent_sex_type! </span><span class="si">{</span><span class="n">agent_sex_type</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">partner_sex_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sex_types</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Invalid partner_sex_type! </span><span class="si">{</span><span class="n">partner_sex_type</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="n">agent_match</span> <span class="o">=</span> <span class="n">agent_sex_type</span> <span class="ow">in</span> <span class="n">sex_types</span><span class="p">[</span><span class="n">partner_sex_type</span><span class="p">]</span><span class="o">.</span><span class="n">sleeps_with</span>
    <span class="n">partner_match</span> <span class="o">=</span> <span class="n">partner_sex_type</span> <span class="ow">in</span> <span class="n">sex_types</span><span class="p">[</span><span class="n">agent_sex_type</span><span class="p">]</span><span class="o">.</span><span class="n">sleeps_with</span>

    <span class="k">return</span> <span class="n">agent_match</span> <span class="ow">and</span> <span class="n">partner_match</span>
</code></pre>
</div>
</details>
</div>
</div>
</div>
</div>
</div>
<h2 id="complex-probabilities">Complex Probabilities</h2>
<div class="doc doc-object doc-module">
<div class="doc doc-contents first">
<div class="doc doc-children">
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="titan.probabilities.adherence_prob">
<code class="highlight language-python">
adherence_prob<span class="p">(</span><span class="n">adherence</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>Mapping from HAART adherence levels to probabilities.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>adherence</code></td>
<td><code>int</code></td>
<td>
<p>HAART adherence level</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>float</code></td>
<td>
<p>probability of agent transitioning from HIV+ to AIDS</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>titan/probabilities.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="nd">@utils</span><span class="o">.</span><span class="n">memo</span>
<span class="k">def</span> <span class="nf">adherence_prob</span><span class="p">(</span><span class="n">adherence</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    Mapping from HAART adherence levels to probabilities.</span>

<span class="sd">    args:</span>
<span class="sd">        adherence: HAART adherence level</span>

<span class="sd">    returns:</span>
<span class="sd">        probability of agent transitioning from HIV+ to AIDS</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">adherence</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0051</span>
    <span class="k">elif</span> <span class="n">adherence</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0039</span>
    <span class="k">elif</span> <span class="n">adherence</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0032</span>
    <span class="k">elif</span> <span class="n">adherence</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0025</span>
    <span class="k">elif</span> <span class="n">adherence</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0008</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0051</span>
</code></pre>
</div>
</details>
</div>
</div>
<div class="doc doc-object doc-function">
<h3 class="doc doc-heading" id="titan.probabilities.get_death_rate">
<code class="highlight language-python">
get_death_rate<span class="p">(</span><span class="n">hiv</span><span class="p">,</span> <span class="n">aids</span><span class="p">,</span> <span class="n">drug_type</span><span class="p">,</span> <span class="n">haart_adh</span><span class="p">,</span> <span class="n">race</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">steps_per_year</span><span class="p">)</span> </code>
</h3>
<div class="doc doc-contents">
<p>Find the death rate of an agent given a set of attributes.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>hiv</code></td>
<td><code>bool</code></td>
<td>
<p>whether the agent is HIV+</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>aids</code></td>
<td><code>bool</code></td>
<td>
<p>whether the agent has AIDS</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>drug_type</code></td>
<td><code>str</code></td>
<td>
<p>whether the PWID base death rate should be used or the base one</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>haart_adh</code></td>
<td><code>int</code></td>
<td>
<p>level of HAART adherence</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>race</code></td>
<td><code>str</code></td>
<td>
<p>the race of the agent</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>location</code></td>
<td><code>Location</code></td>
<td>
<p>agent's location</p>
</td>
<td><em>required</em></td>
</tr>
<tr>
<td><code>steps_per_year</code></td>
<td><code>int</code></td>
<td>
<p>the number of model steps in a year</p>
</td>
<td><em>required</em></td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>float</code></td>
<td>
<p>the probability of an agent with these characteristics dying in a given time step</p>
</td>
</tr>
</tbody>
</table>
<details class="quote">
<summary>Source code in <code>titan/probabilities.py</code></summary>
<div class="highlight">
<pre><span></span><code><span class="nd">@utils</span><span class="o">.</span><span class="n">memo</span>
<span class="k">def</span> <span class="nf">get_death_rate</span><span class="p">(</span>
    <span class="n">hiv</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">aids</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">drug_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">haart_adh</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">race</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">location</span><span class="p">:</span> <span class="n">Location</span><span class="p">,</span>
    <span class="n">steps_per_year</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    Find the death rate of an agent given a set of attributes.</span>

<span class="sd">    args:</span>
<span class="sd">        hiv: whether the agent is HIV+</span>
<span class="sd">        aids: whether the agent has AIDS</span>
<span class="sd">        drug_type: whether the PWID base death rate should be used or the base one</span>
<span class="sd">        haart_adh: level of HAART adherence</span>
<span class="sd">        race: the race of the agent</span>
<span class="sd">        location: agent's location</span>
<span class="sd">        steps_per_year: the number of model steps in a year</span>

<span class="sd">    returns:</span>
<span class="sd">        the probability of an agent with these characteristics dying in a given time step</span>
<span class="sd">    """</span>
    <span class="n">param</span> <span class="o">=</span> <span class="n">location</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">demographics</span>

    <span class="k">if</span> <span class="n">drug_type</span> <span class="o">==</span> <span class="s2">"Inj"</span><span class="p">:</span>
        <span class="n">death_param</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="n">race</span><span class="p">]</span><span class="o">.</span><span class="n">PWID</span><span class="o">.</span><span class="n">death_rate</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">death_param</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="n">race</span><span class="p">]</span><span class="o">.</span><span class="n">death_rate</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">death_param</span><span class="o">.</span><span class="n">base</span>

    <span class="k">if</span> <span class="n">aids</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">*=</span> <span class="n">death_param</span><span class="o">.</span><span class="n">aids</span>
    <span class="k">elif</span> <span class="n">hiv</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">haart_adh</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">*=</span> <span class="n">death_param</span><span class="o">.</span><span class="n">haart_adherent</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">*=</span> <span class="n">death_param</span><span class="o">.</span><span class="n">hiv</span>

    <span class="c1"># putting it into per 1 person-month from per 1000 person years</span>
    <span class="k">return</span> <span class="n">p</span> <span class="o">/</span> <span class="p">(</span><span class="n">steps_per_year</span> <span class="o">*</span> <span class="mf">1000.0</span><span class="p">)</span>
</code></pre>
</div>
</details>
</div>
</div>
</div>
</div>
</div></div>
</div>
</div>
<footer class="col-md-12">
<hr/>
<p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
</footer>
<script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
<script defer="" src="../../js/base.js"></script>
<script defer="" src="../../search/main.js"></script>
<div aria-hidden="true" aria-labelledby="searchModalLabel" class="modal" id="mkdocs_search_modal" role="dialog" tabindex="-1">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
<h4 class="modal-title" id="searchModalLabel">Search</h4>
<button class="close" data-dismiss="modal" type="button"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
</div>
<div class="modal-body">
<p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
<form>
<div class="form-group">
<input class="form-control" id="mkdocs-search-query" placeholder="Search..." title="Type search term here" type="search"/>
</div>
</form>
<div id="mkdocs-search-results"></div>
</div>
<div class="modal-footer">
</div>
</div>
</div>
</div><div aria-hidden="true" aria-labelledby="keyboardModalLabel" class="modal" id="mkdocs_keyboard_modal" role="dialog" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
<button class="close" data-dismiss="modal" type="button"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
</div>
<div class="modal-body">
<table class="table">
<thead>
<tr>
<th style="width: 20%;">Keys</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td class="help shortcut"><kbd>?</kbd></td>
<td>Open this help</td>
</tr>
<tr>
<td class="next shortcut"><kbd>n</kbd></td>
<td>Next page</td>
</tr>
<tr>
<td class="prev shortcut"><kbd>p</kbd></td>
<td>Previous page</td>
</tr>
<tr>
<td class="search shortcut"><kbd>s</kbd></td>
<td>Search</td>
</tr>
</tbody>
</table>
</div>
<div class="modal-footer">
</div>
</div>
</div>
</div>
</body>
</html>
